import sqlite3

def criar_conexao():
    conexao = sqlite3.connect('Banco_DE_DADOS.db')
    return conexao

def criar_tabela():
    conexao = criar_conexao()
    cursor = conexao.cursor()
    
    
    # Cria tabela principal de animes
    cursor.execute(
        """ 
            CREATE TABLE anime (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                titulo TEXT NOT NULL,
                ano_inicial INTEGER NOT NULL,
                ano_final INTEGER,
                nota REAL
            );
        """
    )
    
    # Cria tabela de avaliações separada
    cursor.execute(
        """
            CREATE TABLE IF NOT EXISTS avaliacao (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                anime_id INTEGER NOT NULL,
                nota REAL NOT NULL,
                FOREIGN KEY(anime_id) REFERENCES anime(id)
            );
        """
    )

    conexao.commit()
    conexao.close()
    print("Tabelas 'anime' e 'avaliacao' criadas com sucesso!")



def inserir_anime(titulo, ano_inicial, ano_final, nota):
    conexao = criar_conexao()
    cursor = conexao.cursor()
    cursor.execute(
        """
            INSERT INTO anime (titulo,ano_inicial,ano_final,nota)
            VALUES (?, ?, ?, ?);
        """,
        (titulo, ano_inicial, ano_final, nota)
    )
    conexao.commit()
    conexao.close()
    print("Anime inserido com sucesso!")

def atualizar_anime(id, titulo, ano_inicial,ano_final, nota):
    conexao = criar_conexao()
    cursor = conexao.cursor()
    cursor.execute(
        """
            UPDATE anime
            SET titulo = ?, ano_inicial = ?,ano_final = ?, nota = ?
            WHERE id = ?;
        """,
        (titulo, ano_inicial,ano_final, nota, id)
    )
    conexao.commit()
    conexao.close()


def adicionar_avaliacao(anime_id, nota):
    
    conexao = criar_conexao()
    cursor = conexao.cursor()

    cursor.execute(
        "INSERT INTO avaliacao (anime_id, nota) VALUES (?, ?);",
        (anime_id, nota)
    )

    cursor.execute(
        "SELECT AVG(nota) FROM avaliacao WHERE anime_id = ?;",
        (anime_id,)
    )
    media = cursor.fetchone()[0]

    cursor.execute(
        "UPDATE anime SET nota = ? WHERE id = ?;",
        (media, anime_id)
    )

    conexao.commit()
    conexao.close()

    print(f"⭐ Avaliação adicionada! Nova média: {round(media, 2)}")

def listar_animes():
    conexao = criar_conexao()
    cursor = conexao.cursor()
    cursor.execute(
        """
            SELECT * FROM anime;
        """
    )
    animes = cursor.fetchall()
    conexao.close()
    return animes